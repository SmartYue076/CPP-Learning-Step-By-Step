### 第四章 文件管理（二）

#### 文件系统操作

##### 整体架构

在文件系统和应用程序间有一层抽象层，称为虚拟文件系统（VFS）

- VFS作为抽象层向应用层提供了统一的文件接口（read，write等）
- VFS实现了一些公共的功能，如Inode Cache和Page Cache等
- 规范了接口

VFS向应用层提供统一接口，具体实现不同文件系统有不同实现，VFS将函数指针指向对应函数

<img src="../../img/fs_architecture.png" width=500px />

##### 核心操作

**文件系统的注册**

在Linux中，具体文件系统通常是一个内核模块，在内核模块被夹在时完成文件系统的注册

**磁盘挂载**

将dentry修改为挂载点，增加上级目录inode项

**打开文件**

1. 获取可用的文件描述符
2. 打开文件，分配file结构体（inode，文件系统函数指针等）。（分为递归inode获得文件名，通过inode和dentry的对应关系逐层查找，之后设置file的指针）
3. 将file指针关联到文件描述符

#### 关键技术

##### 缓存技术

将近期访问文件的inode缓存道内存中，空间满后通过**LRU或LFU**替换

##### 预读算法

会比请求的数据块多读一些数据。触发条件是：

- 当有多个地址连续的读请求时
- 当访问到有预读标记的缓存时

##### 快照与克隆技术

**快照**实现文件的可读备份，有两种方法，一种是写时拷贝（COW），在做完快照后第一次对文件写会拷贝文件内容

另一种是写时重定位（ROW），原始文件写数据时不在原有位置，而是分配一个新位置，更新逻辑地址和实际位置对应关系

**克隆**实现文件的可写备份，多用ROW实现，和快照区别是可写，数据隔离

